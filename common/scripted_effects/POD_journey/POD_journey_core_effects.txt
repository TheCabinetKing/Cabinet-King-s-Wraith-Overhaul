
# needs to be called with 6 arguments
# TYPE     - the journey ID, necessary to make everything else work
# GUITYPE  - can be either journey or great_journey, used in the journey window
# MONTHLY  - tells the monthly tick effect which script value to use for planning speed
# GOLD     - upfront gold cost (can be 0)
# PRESTIGE - upfront prestige cost (can be 0)
# PIETY    - upfront piety cost (can be 0)
POD_add_to_journey_list = {
	# Stories need to be initialized on a character, so let's use Charon
	character:POD_wraith_01 = {
		create_story = {
			type = POD_story_journey_gui
			save_scope_as = temp_journey
		}
		
		scope:temp_journey = {
			set_variable = {
				name = journey_type
				value = flag:$TYPE$
			}
			set_variable = {
				name = progress_value
				value = flag:$MONTHLY$
			}
			set_variable = {
				name = gold_cost
				value = {
					value = $GOLD$
					multiply = journey_cost_mult
				}
			}
			set_variable = {
				name = prestige_cost
				value = {
					value = $PRESTIGE$
					multiply = journey_cost_mult
				}
			}
			set_variable = {
				name = piety_cost
				value = {
					value = $PIETY$
					multiply = journey_cost_mult
				}
			}
			set_variable = {
				name = phase
				value = flag:template
			}
			# Fix for "Flag is set but is never used" in the error log
			# since these flags are only used in datafunctions
			if = {
				limit = { var:journey_type = flag:$TYPE$ }
				set_variable = {
					name = journey_type
					value = flag:$TYPE$
				}
			}
		}
		
		add_to_global_variable_list = {
			name = $GUITYPE$_GUI_list
			target = scope:temp_journey
		}
	}
}

# can call this after an update to make new Journeys visible in the GUI
POD_refresh_journey_GUI = {
	POD_clear_journey_GUI = { GUITYPE = journey }
	POD_clear_journey_GUI = { GUITYPE = great_journey }
	POD_clear_journey_GUI = { GUITYPE = seek_knowledge }
	POD_clear_journey_GUI = { GUITYPE = realm_mastery }
	POD_clear_journey_GUI = { GUITYPE = sorcery_legendary_studying }
	#POD_clear_journey_GUI = { GUITYPE = find_artifact }
	
	POD_initialize_journey_GUI = yes
}

POD_clear_journey_GUI = {
	every_in_global_list = {
		variable = $GUITYPE$_GUI_list
		end_story = yes
	}
	clear_global_variable_list = $GUITYPE$_GUI_list
}

# TYPE    - journey ID
# MONTHLY - planning speed, used by POD_journey_monthly_tick
POD_start_journey_effect = {
	create_story = {
		type = POD_story_journey
		save_scope_as = temp_journey
	}
	
	hidden_effect_new_object = {
		scope:temp_journey = {
			set_variable = {
				name = journey_type
				value = $TYPE$
			}
			set_variable = {
				name = progress_value
				value = $MONTHLY$
			}
		}
	}

	POD_finish_journey_setup_effect = { JOURNEY = scope:temp_journey }
}

# call in character scope
# TEMPLATE is a story cycle, like the ones created by POD_add_to_journey_list
POD_start_journey_from_template_effect = {
	POD_start_journey_effect = {
		TYPE    = $TEMPLATE$.var:journey_type
		MONTHLY = $TEMPLATE$.var:progress_value
	}
}

POD_find_and_start_journey_effect = {
	every_in_global_list = {
		variable = journey_GUI_list
		limit = { var:journey_type = flag:$TYPE$ }
		save_scope_as = template_story
	}
	if = {
		limit = { NOT = { exists = scope:template_story } }
		every_in_global_list = {
			variable = great_journey_GUI_list
			limit = { var:journey_type = flag:$TYPE$ }
			save_scope_as = template_story
		}
	}
	hidden_effect_new_object = {
		POD_start_journey_from_template_effect = {
			TEMPLATE = scope:template_story
		}
	}
}

# for things like character interactions
# TYPE    - journey ID
# MONTHLY - planning speed, used by POD_journey_monthly_tick
# TARGET  - the character targeted by the journey
POD_start_targeted_journey_effect = {
	create_story = {
		type = POD_story_journey
		save_scope_as = temp_journey
	}
	
	hidden_effect_new_object = {
		scope:temp_journey = {
			set_variable = {
				name = journey_type
				value = flag:$TYPE$
			}
			set_variable = {
				name = progress_value
				value = flag:$MONTHLY$
			}
			set_variable = {
				name = target
				value = $TARGET$
			}
		}
	}

	POD_finish_journey_setup_effect = { JOURNEY = scope:temp_journey }
}

# for things like character interactions
# TYPE    - journey ID
# MONTHLY - planning speed, used by POD_journey_monthly_tick
# TARGET  - the artifact targeted by the journey
POD_start_artifact_journey_effect = {
	$TARGET$ = { save_scope_as = journey_artifact }

	create_story = {
		type = POD_story_journey
		save_scope_as = temp_journey
	}
	
	hidden_effect_new_object = {
		scope:temp_journey = {
			set_variable = {
				name = journey_type
				value = flag:$TYPE$
			}
			set_variable = {
				name = progress_value
				value = flag:$MONTHLY$
			}
			set_variable = {
				name = target_artifact
				value = scope:journey_artifact
			}
		}
	}

	POD_finish_journey_setup_effect = { JOURNEY = scope:temp_journey }
}

POD_start_trait_journey_effect = {
	$TRAIT$ = { save_scope_as = journey_trait }
	custom_tooltip = $TOOLTIP$

	create_story = {
		type = POD_story_journey
		save_scope_as = temp_journey
	}
	
	hidden_effect_new_object = {
		scope:temp_journey = {
			set_variable = {
				name = journey_type
				value = flag:$TYPE$
			}
			set_variable = {
				name = progress_value
				value = flag:$MONTHLY$
			}
			set_variable = {
				name = target_trait
				value = scope:journey_trait
			}
		}
	}

	POD_finish_journey_setup_effect = { JOURNEY = scope:temp_journey }
}

POD_finish_journey_setup_effect = {
	if = {
		limit = { POD_is_in_travel_phase_trigger = yes }

		custom_tooltip = POD_new_journey_starts_paused_tt

		hidden_effect_new_object = {
			$JOURNEY$ = {
				set_variable = {
					name = phase
					value = flag:paused
				}
				prev = {
					add_to_variable_list = {
						name = paused_journeys
						target = prev
					}
				}
			}
		}
	}
	else = {
		hidden_effect_new_object = {
			if = {
				limit = { has_variable = current_journey }
				POD_pause_journey_effect = yes
			}
			
			set_variable = {
				name = current_journey
				value = $JOURNEY$
			}
		}
	}
	
	hidden_effect_new_object = {
		if = {
			limit = { $JOURNEY$ = { POD_is_instant_journey_trigger = yes } }
			POD_instantly_complete_journey_effect = yes
		}
	}
}

POD_start_trait_study_journey_effect = {
	hidden_effect = { POD_increment_seek_knowledge_cost_effect = yes }
	POD_start_trait_journey_effect = {
		TRAIT   = $TRAIT$
		TOOLTIP = POD_start_trait_study_journey_tt
		TYPE    = study_trait
		MONTHLY = seek_knowledge
	}
}

POD_start_anatomy_study_journey_effect = {
	POD_start_trait_journey_effect = {
		TRAIT   = $TRAIT$
		TOOLTIP = POD_start_anatomy_study_journey_tt
		TYPE    = study_anatomy
		MONTHLY = twelve_months
	}
}

POD_pause_journey_effect = {
	if = {
		limit = {
			POD_is_in_travel_phase_trigger = no
		}
		
		var:current_journey ?= {
			set_variable = {
				name = phase
				value = flag:paused
			}
			prev = {
				add_to_variable_list = {
					name = paused_journeys
					target = var:current_journey
				}
				remove_variable = current_journey
			}
		}
	}
}

POD_force_pause_journey_effect = {
	if = {
		limit = {
			has_character_flag = POD_is_in_travel_phase
		}
		remove_character_flag = POD_is_in_travel_phase
	}
	if = {
		limit = { has_variable = current_journey }
	
		var:current_journey = {
			set_variable = {
				name = phase
				value = flag:paused
			}
		}
		POD_pause_journey_effect = yes
	}
}

# character scope, called in monthly pulse
POD_journey_monthly_tick = {
	# check if any journey targets have died
	save_scope_as = temp_player
	if = {
		limit = {
			var:current_journey ?= {
				var:target ?= { is_alive = no }
				NOT = { has_variable = on_return_trip }
			}
		}
		POD_clear_journeys_with_target_effect = { TARGET = scope:temp_player.var:current_journey.var:target }
	}
	every_in_list = {
		variable = paused_journeys
		limit = {
			var:target ?= { is_alive = no }
			NOT = { has_variable = on_return_trip }
		}
		save_scope_as = temp_journey
		scope:temp_player = {
			POD_clear_journeys_with_target_effect = { TARGET = scope:temp_journey.var:target }
		}
	}
	# check if any target artifacts were destroyed
	if = {
		limit = {
			var:current_journey ?= {
				has_variable = target_artifact
				NOT = { exists = var:target_artifact }
				NOT = { has_variable = on_return_trip }
			}
		}
		var:current_journey.var:travel_plan ?= {
			resume_travel_plan = yes
			prev = { return_home = yes }
		}
		POD_journey_cleanup_effect = yes
		trigger_event = POD_journey_maintenance.21
	}
	every_in_list = {
		variable = paused_journeys
		limit = {
			has_variable = target_artifact
			NOT = { exists = var:target_artifact }
			NOT = { has_variable = on_return_trip }
		}
		scope:temp_player = {
			remove_list_variable = {
				name = paused_journeys
				target = prev
			}
			trigger_event = POD_journey_maintenance.21
		}
		end_story = yes
	}
	# check if player already has the trait they're trying to learn
	if = {
		limit = {
			var:current_journey ?= {
				var:journey_type ?= flag:study_trait
				scope:temp_player = { has_trait = prev.var:target_trait }
			}
		}
		POD_journey_cleanup_effect = yes
		send_interface_message = {
			type  = POD_journey_abandoned
			title = POD_journey_abandoned_title
			desc  = POD_journey_abandoned_desc_trait
		}
	}
	every_in_list = {
		variable = paused_journeys
		limit = {
			var:journey_type ?= flag:study_trait
			scope:temp_player = { has_trait = prev.var:target_trait }
		}
		scope:temp_player = {
			remove_list_variable = {
				name = paused_journeys
				target = prev
			}
			send_interface_message = {
				type  = POD_journey_abandoned
				title = POD_journey_abandoned_title
				desc  = POD_journey_abandoned_desc_trait
			}
		}
		end_story = yes
	}
	if = {
		limit = {
			var:current_journey ?= {
				POD_is_seek_knowledge_journey_trigger = yes
				NOT = { has_variable = on_return_trip }
				scope:temp_player = {
					POD_already_has_seek_knowledge_trait_trigger = {
						VAR = prev.var:journey_type
					}
				}
			}
		}
		var:current_journey.var:travel_plan ?= {
			resume_travel_plan = yes
		}
		return_home = yes
		POD_journey_cleanup_effect = yes
		send_interface_message = {
			type  = POD_journey_abandoned
			title = POD_journey_abandoned_title
			desc  = POD_journey_abandoned_desc_trait
		}
	}
	every_in_list = {
		variable = paused_journeys
		limit = {
			POD_is_seek_knowledge_journey_trigger = yes
			NOT = { has_variable = on_return_trip }
			scope:temp_player = {
				POD_already_has_seek_knowledge_trait_trigger = {
					VAR = prev.var:journey_type
				}
			}
		}
		scope:temp_player = {
			remove_list_variable = {
				name = paused_journeys
				target = prev
			}
			send_interface_message = {
				type  = POD_journey_abandoned
				title = POD_journey_abandoned_title
				desc  = POD_journey_abandoned_desc_trait
			}
		}
		end_story = yes
	}
	# bandaid fix for clearing out journeys that got stuck
	if = {
		limit = {
			var:current_journey ?= { has_variable = on_return_trip }
			NOT = { exists = current_travel_plan }
		}
		POD_journey_post_travel_cleanup = yes
	}
	# progress the journey
	POD_select_progress_value_effect = yes
}

POD_instantly_complete_journey_effect = {
	POD_journey_progress = { AMOUNT = instant_progress }
}

# progress the current journey by the specified AMOUNT
POD_journey_progress = {
	save_scope_value_as = {
		name  = journey_progress
		value = $AMOUNT$
	}
	if = { 
		limit = {
			exists = var:current_journey
			var:current_journey.var:total_progress < 100
		}

		custom_description = {
			text = POD_journey_progress_increase_tooltip
			value = $AMOUNT$

			var:current_journey = {
				set_variable = {
					name = total_progress
					value = {
						value = var:total_progress
						add = scope:journey_progress
						min = 0
						max = 100
					}
				}
				if = {
					limit = { var:total_progress = 100 }
					prev = { POD_journey_planning_finished_effect = yes }
				}
			}
		}
	}
}

POD_journey_planning_finished_effect = {
	switch = {
		trigger = var:current_journey.var:journey_type
			
		# If looking for contracts, just spawn them and show an interface message
		flag:look_for_contracts = {
			trigger_event = POD_journey_maintenance.3
		}
		
		# If hunting someone located in your capital, skip the first event
		flag:hunt_target = {
			if = {
				limit = {
					OR = {
						AND = {
							var:current_journey.var:target.location ?= capital_province
							POD_can_start_travel_phase_trigger = yes
						}
						# Hunting someone in your travel entourage
						AND = {
							exists = current_travel_plan
							var:current_journey.var:target = {
								current_travel_plan ?= prev.current_travel_plan
							}
						}
					}
				}
				POD_journey_instant_start = { EVENT = POD_vamphunt.7000 }
			}
			else = {
				trigger_event = POD_journey_maintenance.1
			}
		}
		
		# If learning true name, skip first event
		flag:learn_true_name = {
			trigger_event = POD_learn_true_name.1
		}
		
		# When hunting in your capital, choose a different ending event (with additional options)
		flag:hunt_in_capital = {
			if = {
				limit = {
					OR = {
						POD_can_start_travel_phase_trigger = yes
						# LAAMPs can do this while traveling, since they travel a lot for contracts
						POD_can_start_instant_journey_as_laamp_trigger = yes
						# QoL: Finish the Journey while acting as a commander (since commanders can teleport anyway)
						is_in_army = yes
					}
				}
				trigger_event = POD_journey_maintenance.2
			}
			else = {
				trigger_event = POD_journey_maintenance.1
			}
		}
		
		# If training with your Pack, skip the first event
		flag:fera_training = {
			if = {
				limit = {
					OR = {
						POD_can_start_travel_phase_trigger = yes
						# LAAMPs can do this while traveling, since they travel a lot for contracts
						POD_can_start_instant_journey_as_laamp_trigger = yes
						# QoL: Finish the Journey while acting as a commander (since commanders can teleport anyway)
						is_in_army = yes
					}
				}
				POD_journey_instant_start = { EVENT = POD_fera_pack.1 }
			}
			else = {
				trigger_event = POD_journey_maintenance.1
			}
		}

		flag:fera_spirit_quest = {
			if = {
				limit = {
					OR = {
						POD_can_start_travel_phase_trigger = yes
						# LAAMPs can do this while traveling, since they travel a lot for contracts
						POD_can_start_instant_journey_as_laamp_trigger = yes
						# QoL: Finish the Journey while acting as a commander (since commanders can teleport anyway)
						is_in_army = yes
					}
				}
				POD_journey_instant_start = { EVENT = POD_fera_spirit_quest.1000 }
			}
			else = {
				trigger_event = POD_journey_maintenance.1
			}
		}
		
		# If studying a trait, skip the first event
		flag:study_trait = {
			POD_journey_instant_start = { EVENT = POD_seek_knowledge.100 }
		}
		flag:study_anatomy = {
			POD_journey_instant_start = { EVENT = POD_transmogrify.1004 }
		}
		flag:study_true_name_journey = {
			POD_journey_instant_start = { EVENT = POD_learn_true_name.2 }
		}
		flag:study_true_name_trait_journey = {
			POD_journey_instant_start = { EVENT = POD_learn_true_name.4 }
		}
		
		# Default ending event
		fallback = {
			trigger_event = POD_journey_maintenance.1
		}
	}
}

POD_journey_select_random_destination_effect = {
	if = {
		limit = { NOT = { exists = var:current_journey.var:destination } }
		
		save_temporary_scope_as = temp_actor
		
		random_county = {
			limit = {
				county_controller = { in_diplomatic_range = scope:temp_actor }
			}
			prev.var:current_journey = {
				set_variable = {
					name = destination
					value = prev.title_province
				}
			}
		}
	}
}

POD_journey_select_teacher_destination_effect = {
	if = {
		limit = { NOT = { exists = var:current_journey.var:destination } }
		
		save_temporary_scope_as = temp_actor

		if = {
			limit = { POD_has_coterie_members_trigger = yes }

			if = {
				limit = {
					var:coterie = {
						any_in_list = {
							variable = members
							count > 0
							#NOT = { this = scope:temp_actor }
							$TRIGGER$
						}
					}
				}
				capital_province = {
					save_temporary_scope_as = temp_province
				}
			}
		}
		
		if = {
			limit = { NOT = { exists = scope:temp_province } }
			ordered_ruler = {
				limit = {
					$TRIGGER$
					#NOT = { this = scope:temp_actor }
					opinion = {
						target = scope:temp_actor
						value >= 0
					}
					is_landed = yes

					save_temporary_scope_value_as = {
						name = temp_distance
						value = "capital_province.squared_distance(scope:temp_actor.capital_province)"
					}
					scope:temp_distance > 150000

					save_temporary_scope_as = temp_target
					NOT = { POD_custom_incompatible_splats_trigger = { ACTOR = scope:temp_actor RECIPIENT = scope:temp_target } }
				}
				order_by = {
					value = "capital_province.squared_distance(scope:temp_actor.capital_province)"
					multiply = -1
				}
				position = 0
				capital_province = {
					save_temporary_scope_as = temp_province
				}
			}
		}
		
		if = {
			limit = { NOT = { exists = scope:temp_province } }
			random_county = {
				limit = {
					save_temporary_scope_value_as = {
						name = temp_distance
						value = "title_province.squared_distance(scope:temp_actor.capital_province)"
					}
					scope:temp_distance > 700000
					scope:temp_distance < 4000000
				}
				title_province = {
					save_temporary_scope_as = temp_province
				}
			}
		}
		
		var:current_journey = {
			set_variable = {
				name = destination
				value = scope:temp_province
			}
		}
	}
}

POD_journey_select_freehold_destination_effect = {
	if = {
		limit = { NOT = { exists = var:current_journey.var:destination } }
		
		save_temporary_scope_as = temp_actor
		
		ordered_province = {
			limit = {
				has_building_with_flag = freehold
				NOT = {
					prev = {
						is_target_in_variable_list = {
							name   = realm_mastery_destinations
							target = prev
						}
					}
				}
			}
			order_by = {
				value = "squared_distance(scope:temp_actor.capital_province)"
				multiply = -1
			}
			position = 0
			save_temporary_scope_as = temp_province
		}
		
		var:current_journey = {
			set_variable = {
				name = destination
				value = scope:temp_province
			}
		}
	}
}

POD_journey_select_capital_destination_effect = {
	#if = {
		#limit = { NOT = { exists = var:current_journey.var:destination } }
		
		var:current_journey = {
			set_variable = {
				name = destination
				value = prev.capital_province
			}
		}
	#}
}

POD_journey_select_target_destination_effect = {
	if = {
		limit = { var:current_journey = { NOT = { exists = var:target } } }
		
		POD_journey_select_capital_destination_effect = yes
	}
	else = {
		var:current_journey = {
			if = {
				limit = { var:target.location = { is_sea_province = yes } }
				if = {
					limit = { exists = var:target.capital_province }
					set_variable = {
						name = destination
						value = var:target.capital_province
					}
				}
				else = {
					set_variable = {
						name = destination
						value = var:target.liege_or_court_owner.capital_province
					}
				}
			}
			else = {
				set_variable = {
					name = destination
					value = var:target.location
				}
			}
		}
	}
}

POD_journey_select_target_capital_effect = {
	#if = {
		#limit = { NOT = { exists = var:current_journey.var:destination } }
		
		var:current_journey = {
			if = {
				limit = { exists = var:target.capital_province }
				set_variable = {
					name = destination
					value = var:target.capital_province
				}
			}
			else_if = {
				limit = {
					exists = var:target.liege_or_court_owner
					exists = var:target.liege_or_court_owner.capital_province
				}
				set_variable = {
					name = destination
					value = var:target.liege_or_court_owner.capital_province
				}
			}
			else = {
				set_variable = {
					name = destination
					value = var:target.location
				}
			}
		}
	#}
}

POD_journey_select_artifact_owner_capital_effect = {
	#if = {
		#limit = { NOT = { exists = var:current_journey.var:destination } }
		
		var:current_journey = {
			if = {
				limit = { exists = var:target_artifact.artifact_owner.capital_province }
				set_variable = {
					name  = destination
					value = var:target_artifact.artifact_owner.capital_province
				}
			}
			else_if = {
				limit = {
					exists = var:target_artifact.artifact_owner.liege_or_court_owner
					exists = var:target_artifact.artifact_owner.liege_or_court_owner.capital_province
				}
				set_variable = {
					name = destination
					value = var:target_artifact.artifact_owner.liege_or_court_owner.capital_province
				}
			}
			else = {
				set_variable = {
					name = destination
					value = var:target_artifact.artifact_owner.location
				}
			}
		}
	#}
}

POD_journey_start_travel_phase = {
	var:current_journey = {
		set_variable = {
			name = phase
			value = flag:travel_phase
		}
	}

	if = {
		limit = { var:current_journey.var:destination = capital_province }
		
		add_character_flag = POD_is_in_travel_phase
		trigger_event = $EVENT$
	}
	else = {
		if = {
			limit = {
				# disable domicile traveling for now since lots of journey code would need to be rewritten
				always = no
				is_landless_adventurer = yes
				has_variable = journey_moves_camp
			}
			start_travel_plan = {
				destination = var:current_journey.var:destination
				on_start_event = POD_journey_maintenance.100
				on_arrival_event = $EVENT$
				on_travel_planner_cancel_event = POD_journey_maintenance.10
				travel_with_domicile = yes
				return_trip = no
				on_arrival_destinations = last
			}
		}
		else = {
			start_travel_plan = {
				destination = var:current_journey.var:destination
				on_start_event = POD_journey_maintenance.100
				on_arrival_event = $EVENT$
				on_travel_planner_cancel_event = POD_journey_maintenance.10
			}
		}
		
		# TODO: add flag to coterie members as well
		# TODO: add current journey to coterie members as well, and pause their previous journey
		#add_character_flag = POD_is_in_travel_phase
	}
}

POD_journey_instant_start = {
	var:current_journey = {
		set_variable = {
			name = destination
			value = prev.capital_province
		}
	}
	POD_journey_start_travel_phase = {
		EVENT = $EVENT$
	}
}

POD_resume_journey_effect = {
	POD_pause_journey_effect = yes
	
	set_variable = {
		name = current_journey
		value = $JOURNEY$
	}
	
	remove_list_variable = {
		name = paused_journeys
		target = $JOURNEY$
	}
	
	var:current_journey = {
		set_variable = {
			name = phase
			value = flag:planning_phase
		}
	}
}

POD_auto_resume_journey_effect = {
	ordered_in_list = {
		variable = paused_journeys
		limit = { var:total_progress < 100 }
		save_temporary_scope_as = autoresume_journey
	}
	if = {
		limit = { exists = scope:autoresume_journey }
		POD_resume_journey_effect = { JOURNEY = scope:autoresume_journey }
	}
}

POD_pause_journey_travel_plan_effect = {
	hidden_effect = {
		var:current_journey ?= {
			var:travel_plan ?= {
				pause_travel_plan = yes
			}
		}
	}
}

POD_end_journey_effect = {
	if = {
		limit = { NOT = { exists = var:current_journey.var:travel_plan } }
		POD_journey_post_travel_cleanup = yes
	}
	else = {
		var:current_journey ?= {
			set_variable = on_return_trip
			var:travel_plan = {
				if = {
					limit = { is_paused = yes }
					resume_travel_plan = yes
				}
			}
		}
	}
}

POD_end_journey_can_retry_effect = {
	hidden_effect = {
		var:current_journey ?= {
			set_variable = can_retry
		}
	}
	POD_end_journey_effect = yes
	custom_tooltip = POD_end_journey_can_retry_tt
}

# TODO: do this for coterie members as well
POD_journey_post_travel_cleanup = {
	if = {
		limit = {
			POD_is_in_travel_phase_trigger = yes
		}
		custom_tooltip = {
			text = POD_end_journey_tt
			POD_journey_cleanup_effect = yes
		}
	}
}

POD_journey_cleanup_effect = {
	if = {
		limit = {
			has_character_flag = POD_is_in_travel_phase
		}
		remove_character_flag = POD_is_in_travel_phase
	}
	if = {
		limit = { var:current_journey = { NOT = { has_variable = can_retry } } }
		var:current_journey = { end_story = yes }
		remove_variable = current_journey
		POD_auto_resume_journey_effect = yes
	}
	else = {
		var:current_journey = {
			remove_variable = can_retry
			remove_variable = on_return_trip
		}
		POD_force_pause_journey_effect = yes
	}
}

POD_clear_journeys_with_target_effect = {
	if = {
		limit = {
			var:current_journey ?= {
				var:target ?= { this = $TARGET$ }
			}
		}
		var:current_journey = {
			var:target = { save_scope_as = journey_target }
		}
		var:current_journey.var:travel_plan ?= {
			resume_travel_plan = yes
		}
		return_home = yes
		POD_journey_cleanup_effect = yes
	}
	every_in_list = {
		variable = paused_journeys
		limit = { var:target ?= { this = $TARGET$ } }
		var:target = { save_scope_as = journey_target }
		prev = {
			remove_list_variable = {
				name = paused_journeys
				target = prev
			}
		}
		end_story = yes
	}
	if = {
		limit = { exists = scope:journey_target }
		trigger_event = POD_journey_maintenance.20
	}
}

POD_abandon_journeys_of_type_effect = {
	if = {
		limit = {
			var:current_journey ?= {
				var:journey_type ?= flag:$TYPE$
			}
		}
		POD_journey_cleanup_effect = yes
	}
	every_in_list = {
		variable = paused_journeys
		limit = { var:journey_type ?= flag:$TYPE$ }
		prev = {
			remove_list_variable = {
				name = paused_journeys
				target = prev
			}
		}
		end_story = yes
	}
}

POD_journey_interaction_pause_hint = {
	if = {
		limit = { scope:actor = { has_variable = current_journey } }
		custom_tooltip = POD_journey_interaction_pause_hint_tt
	}
}

POD_journey_detail_open_effect = {
	remove_variable = journey_detail_window_widget
	remove_variable = journey_detail_window_subtype
	
	if = {
		limit = { var:journey_detail_window ?= $STORY$ }
		remove_variable = journey_detail_window
	}
	else = {
		set_variable = {
			name = journey_detail_window
			value = $STORY$
		}
	
		if = {
			limit = { var:journey_detail_window.var:journey_type = flag:hunt_in_capital }
			POD_hunt_in_capital_create_list_effect = yes
		}
		
		switch = {
			trigger = var:journey_detail_window.var:journey_type
			
			flag:seek_knowledge = {
				set_variable = {
					name = journey_detail_window_widget
					value = flag:seek_knowledge
				}
			}
			
			flag:realm_mastery = {
				set_variable = {
					name = journey_detail_window_widget
					value = flag:realm_mastery
				}
			}
			
			flag:find_artifact = {
				set_variable = {
					name = journey_detail_window_widget
					value = flag:find_artifact
				}
			}
			
			flag:sorcery_legendary_studying = {
				set_variable = {
					name = journey_detail_window_widget
					value = flag:sorcery_legendary_studying
				}
			}

			flag:fulfill_passion = {
				set_variable = {
					name = journey_detail_window_widget
					value = flag:fulfill_passion
				}
			}
			
			fallback = {
				set_variable = {
					name = journey_detail_window_subtype
					value = var:journey_detail_window
				}
			}
		}
	}
}