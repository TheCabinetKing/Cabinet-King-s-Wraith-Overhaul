# TYPE = FLAG
# ACTION = add/subtract
POD_fetter_modifier_from_type = {
	switch = {
		trigger = $TYPE$
		flag:hatred = { $ACTION$_character_modifier = wraith_fetter_hatred_modifier }
		flag:love = { $ACTION$_character_modifier = wraith_fetter_love_modifier }
		flag:greed = { $ACTION$_character_modifier = wraith_fetter_greed_modifier }
		flag:creativity = { $ACTION$_character_modifier = wraith_fetter_creativity_modifier }
		flag:compassion = { $ACTION$_character_modifier = wraith_fetter_compassion_modifier }
		flag:lust = { $ACTION$_character_modifier = wraith_fetter_lust_modifier }
		flag:justice = { $ACTION$_character_modifier = wraith_fetter_justice_modifier }
		flag:conduit = { $ACTION$_character_modifier = wraith_fetter_conduit_modifier }
		flag:bind = { $ACTION$_character_modifier = wraith_fetter_bind_modifier }
	}
}
POD_recalculate_fetter_points = {
	hidden_effect = {
		add_trait_xp = {
			trait = wraith
			track = fetter
			value = -100
		}
		every_in_list = {
			variable = owned_fetter_list
			prev = {
				add_trait_xp = {
					trait = wraith
					track = fetter
					value = {
						value = prev.var:level
						multiply = 10
					}
				}
			}
		}
	}
}
# TYPE = flag NAME
POD_create_empty_fetter = {
	if = { limit = { NOT = { POD_has_fetter_of_type = { TYPE = $TYPE$ } } } 
		create_story = {
			type = POD_story_fetter
			save_scope_as = empty_fetter
		}
		hidden_effect_new_object = {
			scope:empty_fetter = {
				set_variable = {
					name = type
					value = flag:$TYPE$
				}
			}
		}
		add_to_variable_list = { name = owned_fetter_list target = scope:empty_fetter }
	}
}
# TYPE = flag NAME
# LEVEL = Number
POD_assign_fetter_points = {
	random_in_list = {
		variable = owned_fetter_list
		limit = { var:type = flag:$TYPE$ }
		set_variable = {
			name = level
			value = $LEVEL$
		}
		save_scope_as = fetter
	}
	hidden_effect = {
		if = { limit = { POD_has_fetter_of_type = { TYPE = $TYPE$ } }
			POD_fetter_modifier_from_type = { TYPE = flag:$TYPE$ ACTION = remove }
			POD_recalculate_fetter_points = yes
			POD_fetter_modifier_from_type = { TYPE = flag:$TYPE$ ACTION = add }
		}
	}	
}
# TYPE = flag NAME
# OBJECT = Scope
POD_make_object_fetter_type = {
	random_in_list = {
		variable = owned_fetter_list
		limit = { var:type = flag:$TYPE$ }
		if = { limit = { has_variable = object } 
			var:object = { remove_variable = fetter_owner remove_variable = fetter_type remove_variable = fetter_level } 
		}
		set_variable = {
			name = object
			value = $OBJECT$
		}
		save_scope_as = fetter
	}
	$OBJECT$ = {
		set_variable = { name = fetter_owner value = PREV }
		set_variable = { name = fetter_type value = flag:$TYPE$ }
		set_variable = { name = fetter_level value = scope:fetter.var:level }
	}
}
# TYPE = flag NAME
# OBJECT = Scope
# LEVEL = Number
POD_create_full_fetter = {
	custom_tooltip = {
		text = POD_create_full_fetter_text
		POD_create_empty_fetter = { TYPE = $TYPE$ }
		POD_assign_fetter_points = { TYPE = $TYPE$ LEVEL = $LEVEL$ }
		POD_make_object_fetter_type = { TYPE = $TYPE$ OBJECT = $OBJECT$ }
	}
}
POD_destroy_fetter = {
	custom_tooltip = {
		text = POD_destroy_fetter_text
		save_scope_as = fetter
		var:fetter_owner = {
			hidden_effect = {
				POD_fetter_modifier_from_type = { TYPE = scope:fetter.var:fetter_type ACTION = remove }
				every_in_list = {
					variable = owned_fetter_list
					limit = { var:type = scope:fetter.var:fetter_type }
					PREV = { remove_list_variable = { name = owned_fetter_list target = PREV } }
				}
				POD_recalculate_fetter_points = yes
			}
		}
		if = { limit = { exists = learning } remove_relation_fetter = var:fetter_owner }
		remove_variable = fetter_owner 
		remove_variable = fetter_type 
		remove_variable = fetter_level 
	}
}
POD_destroy_fetter_of_type = {
	custom_tooltip = {
		text = POD_destroy_fetter_text
		every_in_list = {
			variable = owned_fetter_list
			limit = { var:type = flag:$TYPE$ }
			if = { limit = { has_variable = object } 
				var:object = {
					POD_destroy_fetter = yes
				}
			}
			else = {
				every_in_list = {
					variable = owned_fetter_list
					limit = { var:type = flag:$TYPE$ }
					PREV = { remove_list_variable = { name = owned_fetter_list target = PREV } }
				}
				PREV = { 
					POD_fetter_modifier_from_type = { TYPE = flag:$TYPE$ ACTION = remove } 
					POD_recalculate_fetter_points = yes
				}
			}
		}
	}
}
# LEVEL = Number
POD_create_fetter_from_type_flag = {
	hidden_effect = {
		set_artifact_rarity_common = yes
		save_scope_as = owner
		create_random_artifact_effect = yes
		hidden_effect_new_object = {
			scope:newly_created_artifact = {
				POD_crafting_give_modifier_based_on_type = yes
			}
		}
	}
	switch = {
		trigger = has_character_flag
		chosen_hatred = {
			POD_create_full_fetter = {
				TYPE = hatred
				LEVEL = $LEVEL$
				OBJECT = scope:newly_created_artifact
			}
		}
		chosen_love = {
			hidden_effect = {
				destroy_artifact = scope:newly_created_artifact
			}
			create_character = {
				location = root.location
				age = { 18 30 }
				faith = root.faith
				culture = root.culture
				gender_female_chance = 50

				trait = mortal
				random_traits = yes
				save_scope_as = mortal
			}
			set_relation_fetter = scope:mortal
			POD_create_full_fetter = {
				TYPE = love
				LEVEL = $LEVEL$
				OBJECT = scope:mortal
			}
		}
		chosen_greed = {
			POD_create_full_fetter = {
				TYPE = greed
				LEVEL = $LEVEL$
				OBJECT = scope:newly_created_artifact
			}
		}
		chosen_creativity = {
			POD_create_full_fetter = {
				TYPE = creativity
				LEVEL = $LEVEL$
				OBJECT = scope:newly_created_artifact
			}
		}
		chosen_compassion = {
			POD_create_full_fetter = {
				TYPE = compassion
				LEVEL = $LEVEL$
				OBJECT = scope:newly_created_artifact
			}
		}
		chosen_lust = {
			POD_create_full_fetter = {
				TYPE = lust
				LEVEL = $LEVEL$
				OBJECT = scope:newly_created_artifact
			}
		}
		chosen_justice = {
			POD_create_full_fetter = {
				TYPE = justice
				LEVEL = $LEVEL$
				OBJECT = scope:newly_created_artifact
			}
		}
	}
}
# TYPE = flag NAME
# LEVEL = Number
# ACTION = add/subtract
POD_increase_fetter_type_level = {
	custom_description = {
		text = POD_increase_fetter_type_level_$ACTION$
		value = $VALUE$
		random_in_list = {
			variable = owned_fetter_list
			limit = { var:type = flag:$TYPE$ }
			change_variable = {
				name = level
				$ACTION$ = $VALUE$
			}
			save_scope_as = fetter
		}
		if = { limit = { POD_has_fetter_of_type = { TYPE = $TYPE$ } }
			POD_fetter_modifier_from_type = { TYPE = flag:$TYPE$ ACTION = remove }
			POD_recalculate_fetter_points = yes
			POD_fetter_modifier_from_type = { TYPE = flag:$TYPE$ ACTION = add }
		}
	}
}
# VALUE = Number
# ACTION = add/subtract
POD_increase_fetter_level = {
	custom_description = {
		text = POD_increase_fetter_type_level_$ACTION$
		value = $VALUE$
		save_scope_as = fetter
		var:fetter_owner ?= {
			random_in_list = {
				variable = owned_fetter_list
				limit = { var:type = scope:fetter.var:fetter_type }
				change_variable = {
					name = level
					$ACTION$ = $VALUE$
				}
				scope:fetter.var:fetter_owner = {
					POD_fetter_modifier_from_type = { TYPE = scope:fetter.var:fetter_type ACTION = remove }
					POD_recalculate_fetter_points = yes
					POD_fetter_modifier_from_type = { TYPE =scope:fetter.var:fetter_type ACTION = add }
				}
			}
		}
	}
}

POD_resolve_fetter = {
	if = { limit = { scope:fetter.var:level = 1 }  
		scope:fetter.var:object = { POD_destroy_fetter = yes }
	}
	else = {
		scope:fetter.var:object = {
			POD_increase_fetter_level = { VALUE = 1 ACTION = subtract }
		}
	}
	add_trait_xp = {
		trait = wraith
		track = fetter_resolved
		value = 10
	}
}

POD_resolve_fetter_of_type = {
	random_in_list = {
		variable = owned_fetter_list
		limit = { var:type = flag:$TYPE$ }
		save_scope_as = fetter
		if = { limit = { scope:fetter.var:level = 1 }  
			scope:fetter.var:object = { POD_destroy_fetter = yes }
		}
		else = {
			scope:fetter.var:object = {
				POD_increase_fetter_level = { VALUE = 1 ACTION = subtract }
			}
		}
	}
	add_trait_xp = {
		trait = wraith
		track = fetter_resolved
		value = 10
	}
}

POD_resolve_all_fetters = {
	add_trait_xp = {
		trait = wraith
		track = fetter_resolved
		value = 100
	}
	every_in_list = {
		variable = owned_fetter_list
		save_scope_as = fetter
		scope:fetter.var:object = { POD_destroy_fetter = yes }
	}
	POD_recalculate_fetter_points = yes
}

# TYPE = flag NAME
POD_pulse_chance_passion = {
	save_scope_value_as = { name = fetter_loca value = flag:$TYPE$ }
	if = { limit = { POD_has_fetter_of_type = { TYPE = $TYPE$ } } 
		if = { limit = { fetter_$TYPE$_level >= 1 } 

			random = {
				chance = {
					value = 20
					multiply = fetter_$TYPE$_level
				}
				send_interface_message = {
					type = event_generic_neutral
					title = POD_passion_fulfilled
					POD_pathos_income_effect = { COUNT = 1 }
					POD_static_stress_gain = { COUNT = -20 }
					if = { limit = { has_perk = fortuitous_wandering_perk } 
						random = {
							chance = 10
							modifier = {
								has_perk = the_face_in_the_crowd_perk
								add = 10
							}
							POD_pathos_income_effect = { COUNT = 1 }
							POD_static_stress_gain = { COUNT = -20 }
						}
					}
				}		
			}
		}
	}
	else = {
		random = {
			chance = 5
			send_interface_message = {
				type = event_generic_neutral
				title = POD_fetter_seed_gained
	
				POD_create_empty_fetter = { TYPE = $TYPE$ }
			}
			remove_variable = fetter_loca
		}
	}
}
# TYPE = flag NAME
POD_pulse_passion = {
	save_scope_value_as = { name = fetter_loca value = flag:$TYPE$ }
	if = { limit = { POD_has_fetter_of_type = { TYPE = $TYPE$ } } 
		if = { limit = { fetter_$TYPE$_level >= 1 } 
			send_interface_message = {
				type = event_generic_neutral
				title = POD_passion_fulfilled
				left_icon = ROOT

				POD_pathos_income_effect = { COUNT = fetter_$TYPE$_level }
				save_scope_value_as = { name = fetter_calc value = { value = fetter_$TYPE$_level multiply = -10 } }
				POD_static_stress_gain = { COUNT = scope:fetter_calc }

				if = { limit = { has_perk = fortuitous_wandering_perk } 
					random = {
						chance = 10
						modifier = {
							has_perk = the_face_in_the_crowd_perk
							add = 10
						}
						POD_pathos_income_effect = { COUNT = fetter_$TYPE$_level }
						save_scope_value_as = { name = fetter_calc value = { value = fetter_$TYPE$_level multiply = -10 } }
						POD_static_stress_gain = { COUNT = scope:fetter_calc }
					}
				}
			}
			
		}
	}
	else = {
		random = {
			chance = 10
			send_interface_message = {
				type = event_generic_neutral
				title = POD_fetter_seed_gained
				POD_create_empty_fetter = { TYPE = $TYPE$ }
			}
		}
	}
}